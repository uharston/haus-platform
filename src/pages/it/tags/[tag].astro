---
import { sanityClient } from "sanity:client";
import type { AstroSeoProps } from "@astrolib/seo";
import Tag from "@components/blog/Tag.astro";
import BaseLayout from "@layouts/BaseLayout.astro";
import { getAllPosts } from "@/sanity/queries/posts";

export async function getStaticPaths() {
    const allPosts = await getAllPosts(sanityClient)

    const uniqueTags = [...new Set(allPosts.flatMap((post) => post.tags || []))];
    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter((post) => post.tags?.includes(tag));
        // Transform Sanity posts to match CollectionEntry format
        const transformedPosts = filteredPosts
            .filter((post) => post.image?.asset?.url) // Only include posts with images
            .map((post) => ({
                slug: post.slug,
                data: {
                    title: post.title,
                    description: post.description,
                    pubDate: new Date(post.pubDate),
                    author: post.author,
                    image: {
                        source: post.image.asset.url,
                        alt: post.image.alt || post.title
                    }
                }
            }));
        return {
            params: { tag },
            props: { posts: transformedPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const seo: AstroSeoProps = {
    title: `${tag} | Majestico Studio`,
    description: `Explore articles and insights on '${tag}' at Majestico Studio. Dive into a wealth of knowledge covering the latest trends and tips in web design and SEO.`,
    canonical: `https://mintaka.co/it/tags/${tag}/`,
};
---

<BaseLayout seo={seo}>
    <Tag tag={tag} posts={posts} />
</BaseLayout>