---
import { sanityClient } from "sanity:client";
import type { AstroSeoProps } from "@astrolib/seo";
import Tag from "@components/blog/Tag.astro";
import BaseLayout from "@layouts/BaseLayout.astro";

export async function getStaticPaths() {
	const allPosts = await sanityClient.fetch(
		`*[_type == "post"] | order(pubDate desc) {
			...,
			"image": {
				"source": image.source.asset->url,
				"alt": image.alt
			}
		}`,
		{},
		{ cache: "no-store" }
	);

	const uniqueTags = [...new Set(allPosts.flatMap((post) => post.tags))];
	return uniqueTags.map((tag) => {
		const filteredPosts = allPosts.filter((post) => post.tags.includes(tag));
		return {
			params: { tag },
			props: { posts: filteredPosts },
		};
	});
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const seo: AstroSeoProps = {
	title: `${tag} | Majestico Studio`,
	description: `Explore articles and insights on '${tag}' at Majestico Studio. Dive into a wealth of knowledge covering the latest trends and tips in web design and SEO.`,
	canonical: `https://mintaka.co/tags/${tag}/`,
};
---

<BaseLayout seo={seo}>
	<Tag tag={tag} posts={posts} />
</BaseLayout>
